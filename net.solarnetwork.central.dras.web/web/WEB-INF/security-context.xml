<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
			http://www.springframework.org/schema/security
			http://www.springframework.org/schema/security/spring-security-4.1.xsd
			http://www.springframework.org/schema/tx
			http://www.springframework.org/schema/tx/spring-tx-4.2.xsd">

	<!-- Use Java @Transactional annotations to declare transactions. -->
	<tx:annotation-driven transaction-manager="transactionManager"/>

	<http security="none" pattern="/js/**"/>
	<http security="none" pattern="/css/**"/>
	
	<!-- Configure Spring Security -->
	<http auto-config="true" use-expressions="false" entry-point-ref="preAuthenticatedProcessingFilterEntryPoint">
		<intercept-url pattern="/u/user/admin/**" access="ROLE_USER_ADMIN"/>
	    <intercept-url pattern="/u/**" access="ROLE_AUTHENTICATED_USER" />
		<!--form-login login-page="/login.do" default-target-url="/login"
			authentication-failure-url="/login.do?login_error=1"/-->
		<logout logout-url="/u/logout.do" logout-success-url="/loggedout.do"/>
		<custom-filter position="PRE_AUTH_FILTER" ref="j2eePreAuthFilter" />
		<!--  TODO: enable CSRF -->
		<csrf disabled="true"/>
	</http>

	<authentication-manager alias="authenticationManager">
		<authentication-provider ref="preAuthenticatedAuthenticationProvider"/>
	</authentication-manager>

	<beans:bean id="preAuthenticatedAuthenticationProvider"
		class="org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider">
		<beans:property name="preAuthenticatedUserDetailsService"
			ref="preAuthenticatedUserDetailsService"/>
	</beans:bean>

	<beans:bean id="preAuthenticatedUserDetailsService"
		class="org.springframework.security.web.authentication.preauth.PreAuthenticatedGrantedAuthoritiesUserDetailsService"/>

	<beans:bean id="j2eePreAuthFilter"
		class="org.springframework.security.web.authentication.preauth.j2ee.J2eePreAuthenticatedProcessingFilter">
		<beans:property name="authenticationManager" ref="authenticationManager"/>
		<beans:property name="authenticationDetailsSource">
			<beans:bean
				class="org.springframework.security.web.authentication.preauth.j2ee.J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource">
				<beans:property name="mappableRolesRetriever">
					<beans:bean class="org.springframework.security.web.authentication.preauth.j2ee.WebXmlMappableAttributesRetriever"/>
				</beans:property>
				<beans:property name="userRoles2GrantedAuthoritiesMapper">
					<beans:bean
						class="org.springframework.security.core.authority.mapping.SimpleAttributes2GrantedAuthoritiesMapper">
						<beans:property name="convertAttributeToUpperCase"
							value="true"/>
					</beans:bean>
				</beans:property>
			</beans:bean>
		</beans:property>
	</beans:bean>

	<beans:bean id="preAuthenticatedProcessingFilterEntryPoint"
		class="org.springframework.security.web.authentication.Http403ForbiddenEntryPoint"/>
	
</beans:beans>
