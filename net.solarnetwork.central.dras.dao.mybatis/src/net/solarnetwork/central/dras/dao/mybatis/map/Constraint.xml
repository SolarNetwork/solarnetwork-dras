<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.dras.dao.mybatis.Constraint">
	
	<insert id="insert-Constraint" parameterType="Constraint">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"> 
              SELECT nextval('solardras.solardras_seq') AS id 
		</selectKey>
		INSERT INTO solardras.dras_constraint 
			(id, 
			event_window_start, event_window_end, 
			<if test="eventWindowFilter != null">event_window_filter,</if> 
			max_event_dur, 
			<if test="maxEventDurationFilter != null">max_event_dur_filter,</if>
			notif_window_max, notif_window_min, 
			<if test="notificationWindowFilter != null">notif_window_filter,</if>
			max_consec_days, 
			<if test="maxConsecutiveDaysFilter != null">max_consec_days_filter,</if>
			<if test="blackoutDatesFilter != null">blackout_filter,</if>
			<if test="validDatesFilter != null">valid_filter</if>
			)
		VALUES
			(#{id}, 
			#{eventWindowStart}, #{eventWindowEnd},
			<if test="eventWindowFilter != null">CAST(#{eventWindowFilter} AS solardras.dras_constraint_filter),</if>
			CAST(#{maxEventDuration} AS interval), 
			<if test="maxEventDurationFilter != null">CAST(#{maxEventDurationFilter} AS solardras.dras_constraint_filter),</if>
			CAST(#{notificationWindowMax} AS interval), CAST(#{notificationWindowMin} AS interval), 
			<if test="notificationWindowFilter != null">CAST(#{notificationWindowFilter} AS solardras.dras_constraint_filter),</if>
			#{maxConsecutiveDays}, 
			<if test="maxConsecutiveDaysFilter != null">CAST(#{maxConsecutiveDaysFilter} AS solardras.dras_constraint_filter),</if>
			<if test="blackoutDatesFilter != null">CAST(#{blackoutDatesFilter} AS solardras.dras_constraint_filter),</if>
			<if test="validDatesFilter != null">CAST(#{validDatesFilter} AS solardras.dras_constraint_filter)</if>
			)
	</insert>

	<update id="update-Constraint" parameterType="Constraint">
		UPDATE solardras.dras_constraint SET
			event_window_start = #{eventWindowStart}, 
			event_window_end = #{eventWindowEnd}, 
			event_window_filter = CAST(#{eventWindowFilter} AS solardras.dras_constraint_filter), 
			max_event_dur = CAST(#{maxEventDuration} AS interval), 
			max_event_dur_filter = CAST(#{maxEventDurationFilter} AS solardras.dras_constraint_filter),
			notif_window_max = CAST(#{notificationWindowMax} AS interval), 
			notif_window_min = CAST(#{notificationWindowMin} AS interval), 
			notif_window_filter = CAST(#{notificationWindowFilter} AS solardras.dras_constraint_filter),
			max_consec_days = #{maxConsecutiveDays}, 
			max_consec_days_filter = CAST(#{maxConsecutiveDaysFilter} AS solardras.dras_constraint_filter),
			blackout_filter = CAST(#{blackoutDatesFilter} AS solardras.dras_constraint_filter), 
			valid_filter = CAST(#{validDatesFilter} AS solardras.dras_constraint_filter)
		WHERE
			id = #{id}
	</update>
	
	<delete id="delete-Constraint" parameterType="long">
		DELETE FROM solardras.dras_constraint
		WHERE id = #{id}
	</delete>

	<resultMap id="BlackoutDateResult" type="DateTimeWindow">
		<result column="blackout_start_date" property="startDate"/>
		<result column="blackout_end_date" property="endDate"/>
	</resultMap>
	
	<resultMap id="ValidDateResult" type="DateTimeWindow">
		<result column="valid_start_date" property="startDate"/>
		<result column="valid_end_date" property="endDate"/>
	</resultMap>
	
	<resultMap id="ConstraintFullResult" type="Constraint">
		<id column="con_id" property="id"/>
		<result column="event_window_start" property="eventWindowStart"/>
		<result column="event_window_end" property="eventWindowEnd"/>
		<result column="event_window_filter" property="eventWindowFilter"/>
		<result column="max_event_dur" property="maxEventDuration"/>
		<result column="max_event_dur_filter" property="maxEventDurationFilter"/>
		<result column="notif_window_max" property="notificationWindowMax"/>
		<result column="notif_window_min" property="notificationWindowMin"/>
		<result column="notif_window_filter" property="notificationWindowFilter"/>
		<result column="max_consec_days" property="maxConsecutiveDays"/>
		<result column="max_consec_days_filter" property="maxConsecutiveDaysFilter"/>
		<result column="blackout_filter" property="blackoutDatesFilter"/>
		<result column="valid_filter" property="validDatesFilter"/>
		
		<association property="blackoutDates" notNullColumn="blackout_con_id" 
			resultMap="net.solarnetwork.central.dras.dao.mybatis.Constraint.BlackoutDateResult"/>
		<association property="validDates" notNullColumn="valid_con_id" 
			resultMap="net.solarnetwork.central.dras.dao.mybatis.Constraint.ValidDateResult"/>
	</resultMap>
	
	<sql id="fragment-Constraint-full-result">
		c.id AS con_id, 
		c.event_window_start, c.event_window_end, c.event_window_filter, 
		CAST(c.max_event_dur AS text), c.max_event_dur_filter,
		CAST(c.notif_window_max AS text), CAST(c.notif_window_min AS text), c.notif_window_filter,
		c.max_consec_days, c.max_consec_days_filter,
		c.blackout_filter, c.valid_filter,
		CASE cwin.kind WHEN CAST('BLACKOUT' as solardras.dtwindow_kind) THEN cwin.con_id END AS blackout_con_id,
		cwin.start_date as blackout_start_date,
		cwin.end_date as blackout_end_date,
		CASE cwin.kind WHEN CAST('VALID' as solardras.dtwindow_kind) THEN cwin.con_id END AS valid_con_id,
		cwin.start_date as valid_start_date,
		cwin.end_date as valid_end_date
	</sql>
	
	<select id="get-Constraint-for-id" resultMap="ConstraintFullResult" parameterType="long">
		SELECT 
		<include refid="fragment-Constraint-full-result"/>
		FROM solardras.dras_constraint c
		LEFT OUTER JOIN solardras.dras_constraint_dtwindow cwin ON cwin.con_id = c.id
		WHERE c.id = #{id}
		ORDER BY c.id, cwin.idx 
	</select>

	<!-- ConstraintWindow support -->
	
	<resultMap id="ConstraintWindowFullResult" type="DateTimeWindow">
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
	</resultMap>

	<select id="findall-Constraint-ConstraintWindow" resultMap="ConstraintWindowFullResult" parameterType="long">
		SELECT start_date, end_date
		FROM solardras.dras_constraint_dtwindow
		WHERE con_id = #{id}
		ORDER BY idx
	</select>
	
	<delete id="delete-Constraint-ConstraintWindow" parameterType="map">
		DELETE FROM solardras.dras_constraint_dtwindow
		WHERE con_id = #{id}
		<if test="index != null">
			AND idx = #{index}
		</if>
	</delete>

	<insert id="insert-Constraint-ConstraintWindow" parameterType="map">
		INSERT INTO solardras.dras_constraint_dtwindow
			(con_id, idx, kind, start_date, end_date)
		VALUES
			(#{id}, #{index}, CAST(#{obj.kind} AS solardras.dtwindow_kind), 
			#{obj.startDate}, #{obj.endDate})
	</insert>

	<update id="update-Constraint-ConstraintWindow" parameterType="map">
		UPDATE solardras.dras_constraint_dtwindow
		SET kind = CAST(#{obj.kind} AS solardras.dtwindow_kind), 
			start_date = #{obj.startDate},
			end_date = #{obj.endDate}
		WHERE con_id = #{id} AND idx = #{index}
	</update>

</mapper>
