<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.dras.dao.mybatis.OutboundMail">
	
	<insert id="insert-OutboundMail" parameterType="OutboundMail">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"> 
              SELECT nextval('solardras.solardras_seq') AS id 
		</selectKey>
		INSERT INTO solardras.outbound_mail
			(id, creator, to_address, message_id, subject, message)
		VALUES
			(#{id}, #{creator}
			, #{to,jdbcType=ARRAY,typeHandler=net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler}
			, #{messageId}, #{subject}, #{messageBody})
	</insert>

	<resultMap id="OutboundMailFullResult" type="OutboundMail">
		<id column="id" property="id"/>
		<result column="created" property="created"/>
		<result column="creator" property="creator"/>
		<result column="to_address" property="to" jdbcType="ARRAY" typeHandler="net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler"/>
		<result column="message_id" property="messageId"/>
		<result column="subject" property="subject"/>
		<result column="message" property="messageBody"/>
	</resultMap>
	
	<select id="get-OutboundMail-for-id" resultMap="OutboundMailFullResult" parameterType="long">
		SELECT id, created, creator, to_address, message_id, subject, message
		FROM solardras.outbound_mail
		WHERE id = #{id}
	</select>

	<resultMap id="OutboundMailFilterResult" type="OutboundMail">
		<id column="id" property="id"/>
		<result column="created" property="created"/>
		<result column="creator" property="creator"/>
		<result column="to_address" property="to" jdbcType="ARRAY" typeHandler="net.solarnetwork.central.dao.mybatis.type.TextArrayTypeHandler"/>
		<result column="message_id" property="messageId"/>
		<result column="subject" property="subject"/>
	</resultMap>
	
	<select id="findall-OutboundMail-Match" resultMap="OutboundMailFilterResult" parameterType="map">
		SELECT id, created, creator, to_address, message_id, subject
		FROM solardras.outbound_mail l
		<where>
			<if test="fts != null">
				fts_default @@ plainto_tsquery(#{fts})
			</if>
		</where>
		ORDER BY id
	</select>
	
</mapper>
