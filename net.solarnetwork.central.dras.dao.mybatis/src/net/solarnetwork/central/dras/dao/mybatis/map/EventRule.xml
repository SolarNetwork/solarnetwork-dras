<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.solarnetwork.central.dras.dao.mybatis.EventRule">
	
	<insert id="insert-EventRule" parameterType="EventRule">
		<selectKey resultType="long" keyProperty="id" order="BEFORE"> 
              SELECT nextval('solardras.solardras_seq') AS id 
		</selectKey>
		INSERT INTO solardras.event_rule 
			(id, creator, kind, rule_name, min_value, max_value, schedule_kind)
		VALUES
			(#{id}, #{creator}, CAST(#{kind} AS solardras.event_rule_kind), 
			#{name}, #{min}, #{max}, 
			CAST(#{scheduleKind} AS solardras.schedule_kind))
	</insert>

	<update id="update-EventRule" parameterType="EventRule">
		UPDATE solardras.event_rule SET
			kind = CAST(#{kind} AS solardras.event_rule_kind),
			rule_name = #{name},
			min_value = #{min},
			max_value = #{max},
			schedule_kind = CAST(#{scheduleKind} AS solardras.schedule_kind)
		WHERE
			id = #{id}
	</update>

	<resultMap id="EventRuleFullResult" type="EventRule">
		<id column="id" property="id"/>
		<result column="created" property="created"/>
		<result column="creator" property="creator"/>
		<result column="kind" property="kind"/>
		<result column="rule_name" property="name"/>
		<result column="min_value" property="min"/>
		<result column="max_value" property="max"/>
		<result column="schedule_kind" property="scheduleKind"/>
		
		<association property="enumeration" column="enumeration" 
			resultMap="net.solarnetwork.central.dras.dao.mybatis.EventRule.EventRuleEnumerationResult"/>
		<association property="schedule" column="schedule" 
			resultMap="net.solarnetwork.central.dras.dao.mybatis.EventRule.EventRuleScheduleResult"/>
	</resultMap>
	
	<resultMap id="EventRuleEnumerationResult" type="double">
		<result column="enumeration" property="enumeration"/>
	</resultMap>
	
	<resultMap id="EventRuleScheduleResult" type="org.joda.time.Duration">
		<result column="schedule" property="schedule"/>
	</resultMap>
	
	<select id="get-EventRule-for-id" resultMap="EventRuleFullResult" parameterType="long">
		SELECT e.id, e.created, e.creator, e.kind, e.rule_name, 
			e.min_value, e.max_value, e.schedule_kind,
			en.target_value as enumeration,
			CAST(s.event_offset AS text) as schedule
		FROM solardras.event_rule e
		LEFT OUTER JOIN solardras.event_rule_enum en ON en.evr_id = e.id
		LEFT OUTER JOIN solardras.event_rule_schedule s ON s.evr_id = e.id
		WHERE e.id = #{id}
	</select>

	<delete id="delete-EventRule-Enumeration" parameterType="map">
		DELETE FROM solardras.event_rule_enum
		WHERE evr_id = #{id}
	</delete>

	<insert id="insert-EventRule-Enumeration" parameterType="map">
		INSERT INTO solardras.event_rule_enum
			(evr_id, target_value)
		VALUES
			(#{id}, #{memberId})
	</insert>

	<delete id="delete-EventRule-Schedule" parameterType="map">
		DELETE FROM solardras.event_rule_schedule
		WHERE evr_id = #{id}
	</delete>

	<insert id="insert-EventRule-Schedule" parameterType="map">
		INSERT INTO solardras.event_rule_schedule
			(evr_id, event_offset)
		VALUES
			(#{id}, CAST(#{memberId} AS interval))
	</insert>

</mapper>
